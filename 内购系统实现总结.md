# EarthLord iOS 内购系统实现总结

> **开发完成时间**: 2026-02-04
> **基于**: StoreKit 2 + Supabase
> **状态**: ✅ 代码实现完成，待测试

---

## 一、实现概览

### 已完成的功能模块

#### ✅ Phase 1: 数据库准备
- 创建 `purchases` 表（购买订单记录）
- 创建 `mailbox` 表（邮箱系统）
- 创建 RLS 安全策略（防止跨用户访问）
- 创建 `send_mail` RPC 函数（30天过期）
- 创建 `claim_mail_partial` RPC 函数（部分领取机制）

#### ✅ Phase 2: StoreKit 2 集成
- 创建 `EarthLord.storekit` 配置文件（4个物资包商品）
- 创建 `PurchaseModels.swift`（产品定义和配置）
- 创建 `MailboxModels.swift`（邮件数据模型）
- 创建 `PurchaseManager.swift`（购买流程管理器）
  - 商品加载
  - 购买验证
  - 发货流程（订单保存 → 生成物品 → 发送邮件 → 标记发货）
  - 交易监听（自动处理未完成交易）
  - 概率奖励系统

#### ✅ Phase 3: 邮箱系统
- 创建 `MailboxManager.swift`（邮箱管理器）
  - 加载邮件列表
  - 未读计数
  - 标记已读
  - 部分领取物品
  - 删除邮件（单个/批量）
- 创建 `MailboxView.swift`（邮箱列表页面）
- 创建 `MailItemRow.swift`（邮件行组件）
- 创建 `MailDetailView.swift`（邮件详情和领取页面）

#### ✅ Phase 4: 商城 UI
- 创建 `StoreView.swift`（商城主页）
- 创建 `SupplyPackCard.swift`（物资包卡片组件）
- 创建 `PurchaseConfirmSheet.swift`（购买确认弹窗）
- 创建 `PurchaseResultView.swift`（购买结果页面）

#### ✅ Phase 5: 集成到个人 Tab
- 修改 `ProfileTabView.swift`
  - 添加邮箱按钮（带未读红点提示）
  - 添加商城按钮
  - 页面加载时自动刷新未读数量

#### ✅ Phase 6: 配置文件
- 更新 `Info.plist`（添加 StoreKit Configuration File 配置）

---

## 二、功能特性

### 🎁 物资包商品（4种）

| 商品名称 | 产品ID | 价格 | 保底物品 | 额外奖励 |
|---------|-------|------|---------|---------|
| 新手物资包 | `com.earthlord.starter_pack` | ¥6 | 矿泉水×5、罐头×3、绷带×2 | 无 |
| 探索物资包 | `com.earthlord.explorer_pack` | ¥12 | 手电筒×1、绳子×2、矿泉水×3 | 10% 传奇手电筒 |
| 建设物资包 | `com.earthlord.builder_pack` | ¥18 | 木材×20、废金属×15、玻璃×10 | 15% 建筑加速令×3 |
| 高级物资包 | `com.earthlord.premium_pack` | ¥28 | 稀有装备×1、各类资源 | 20% 传奇物品×1 |

### 📮 邮箱系统特性

- ✅ **购买发货**：购买后物品发送到邮箱，需手动领取
- ✅ **部分领取**：背包满时只领取能装下的部分，剩余保留在邮件中
- ✅ **未读提示**：邮箱图标显示红点和未读数量
- ✅ **邮件过期**：30天后自动删除（通过 `expires_at` 字段）
- ✅ **批量删除**：一键删除所有已领取的邮件

### 🎲 概率奖励机制

```swift
// 示例：探索物资包有 10% 概率获得传奇手电筒
for bonus in config.bonusItems {
    let random = Int.random(in: 1...100)
    if random <= bonus.probability {
        items.append(bonus.item)
    }
}
```

### 🔒 安全机制

- ✅ **交易验证**：使用 StoreKit 2 的 `VerificationResult` 验证交易真实性
- ✅ **防重复发货**：`transaction_id` 字段唯一索引
- ✅ **RLS 安全策略**：用户只能访问自己的订单和邮件
- ✅ **部分领取幂等性**：多次点击领取不会重复添加物品

---

## 三、文件结构

```
EarthLord/
├── EarthLord.storekit                     # StoreKit 配置文件
├── Info.plist                             # 已添加 SKStoreKitConfigurationFile
├── Models/
│   ├── PurchaseModels.swift               # 购买相关模型
│   └── MailboxModels.swift                # 邮箱相关模型
├── Managers/
│   ├── PurchaseManager.swift              # 购买管理器（StoreKit 2）
│   └── MailboxManager.swift               # 邮箱管理器
└── Views/
    ├── Store/
    │   ├── StoreView.swift                # 商城主页
    │   ├── SupplyPackCard.swift           # 物资包卡片
    │   ├── PurchaseConfirmSheet.swift     # 购买确认弹窗
    │   └── PurchaseResultView.swift       # 购买结果页面
    ├── Mailbox/
    │   ├── MailboxView.swift              # 邮箱列表
    │   ├── MailItemRow.swift              # 邮件行组件
    │   └── MailDetailView.swift           # 邮件详情
    └── Tabs/
        └── ProfileTabView.swift           # 已添加商城和邮箱入口
```

---

## 四、数据库结构

### purchases 表

```sql
CREATE TABLE public.purchases (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    product_id TEXT NOT NULL,
    transaction_id TEXT UNIQUE NOT NULL,       -- 防重复
    purchase_date TIMESTAMPTZ NOT NULL,
    is_delivered BOOLEAN DEFAULT false,
    delivered_at TIMESTAMPTZ,
    ...
);
```

### mailbox 表

```sql
CREATE TABLE public.mailbox (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    mail_type TEXT NOT NULL,                   -- purchase/reward/gift
    title TEXT NOT NULL,
    content TEXT,
    items JSONB NOT NULL,                      -- 物品列表
    is_read BOOLEAN DEFAULT false,
    is_claimed BOOLEAN DEFAULT false,
    claimed_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,                    -- 30天过期
    purchase_id UUID REFERENCES public.purchases(id),
    ...
);
```

### RPC 函数

#### 1. send_mail
```sql
CREATE OR REPLACE FUNCTION send_mail(
    p_user_id UUID,
    p_mail_type TEXT,
    p_title TEXT,
    p_content TEXT,
    p_items JSONB,
    p_purchase_id UUID DEFAULT NULL
) RETURNS UUID
```
**功能**：发送邮件，自动设置 30天过期时间

#### 2. claim_mail_partial
```sql
CREATE OR REPLACE FUNCTION claim_mail_partial(
    p_mail_id UUID,
    p_backpack_limit INT
) RETURNS JSONB
```
**功能**：部分领取邮件物品
- 输入：邮件ID + 背包剩余空间
- 输出：`{claimed_items, remaining_items, space_used}`
- 逻辑：按顺序领取物品直到背包满，更新邮件 `items` 字段

---

## 五、测试指南

### 5.1 StoreKit 沙盒测试

#### 步骤 1：配置沙盒测试账号

1. 打开 **App Store Connect**
2. 进入 **用户与访问** → **沙盒技术** → **测试员**
3. 创建测试账号（邮箱格式：`test@example.com`）

#### 步骤 2：在 Xcode 中测试购买

1. 确保 `EarthLord.storekit` 已在项目中正确配置
2. 在 Xcode 中运行 App（**Product** → **Run**）
3. 进入 **个人 Tab** → 点击 **商城** 按钮
4. 选择任意物资包 → 确认购买
5. 使用沙盒测试账号登录（会自动弹出）
6. 完成购买流程

#### 步骤 3：验证邮箱发货

1. 购买成功后，返回 **个人 Tab**
2. 查看邮箱图标是否显示红点提示
3. 点击邮箱图标进入邮箱列表
4. 确认邮件已到达，物品列表正确

#### 步骤 4：测试部分领取

**方法 A：直接修改背包容量（开发测试）**
```swift
// MailboxManager.swift 第 46 行
private let backpackCapacity = 5  // 临时改为 5
```

**方法 B：填满背包后购买**
1. 先通过其他方式填满背包（留 3-5 个空位）
2. 购买物资包
3. 尝试领取邮件
4. 验证提示："已领取 X 件，剩余 Y 件"
5. 整理背包后再次点击领取

### 5.2 测试清单

| 测试项 | 预期结果 | 状态 |
|-------|---------|------|
| 商品加载 | 显示 4 个物资包，价格正确 | ⬜️ |
| 购买流程 | 弹出确认弹窗 → Apple 支付 → 成功提示 | ⬜️ |
| 邮件发送 | 购买后邮件自动发送到邮箱 | ⬜️ |
| 未读红点 | 邮箱图标显示红点和数量 | ⬜️ |
| 完整领取 | 背包空间足够时全部领取 | ⬜️ |
| 部分领取 | 背包满时只领取部分，剩余保留 | ⬜️ |
| 邮件过期 | 30天后邮件自动过期（需修改数据库测试）| ⬜️ |
| 批量删除 | 删除所有已领取邮件 | ⬜️ |
| 概率奖励 | 购买多次验证概率是否正常 | ⬜️ |
| 防重复发货 | 同一交易ID不重复发货 | ⬜️ |

### 5.3 调试技巧

#### 查看日志

```swift
// ExplorationLogger 已集成到所有 Manager 中
// 购买流程日志
logger.log("开始购买: \(product.displayName)", type: .info)
logger.log("购买成功", type: .success)
logger.logError("购买失败", error: error)

// 邮箱系统日志
logger.log("成功加载 \(mails.count) 封邮件", type: .success)
logger.log("领取成功: 已领 X 件，剩余 Y 件", type: .success)
```

#### 手动发送测试邮件

```swift
// 在 MailboxManager 中已提供测试方法（仅 DEBUG 模式）
#if DEBUG
try await MailboxManager.shared.sendTestMail()
#endif
```

---

## 六、App Store Connect 配置（上线前）

### 6.1 创建真实商品

1. 登录 **App Store Connect**
2. 进入 **我的 App** → 选择 EarthLord
3. 进入 **功能** → **App 内购买项目**
4. 点击 **+** 创建新商品

**配置参数**：

| 字段 | 值 |
|------|---|
| 类型 | 消耗型项目 (Consumable) |
| 参考名称 | 新手物资包 |
| 产品 ID | `com.earthlord.starter_pack` |
| 价格层级 | ¥6.00（Tier 6） |
| 本地化 (zh-Hans) | |
| - 显示名称 | 新手物资包 |
| - 描述 | 包含矿泉水×5、罐头食品×3、绷带×2 |

**重复以上步骤创建其他 3 个商品**。

### 6.2 提交审核

#### 审核要点

- ✅ **商品截图**：展示商城页面和购买流程
- ✅ **隐私政策**：说明内购用途和数据处理
- ✅ **测试账号**：提供沙盒测试账号给审核团队
- ✅ **恢复购买**：虽然是消耗型，但 `restorePurchases()` 已实现
- ✅ **退款政策**：在 App 内或网站提供退款说明

#### App Store 审核指南 3.1.1 (内购)

- ✅ 所有虚拟物品必须通过 IAP 购买（不能用支付宝/微信）
- ✅ 不能暗示其他购买方式
- ✅ 价格必须清晰透明
- ✅ 内购项目不能包含误导性描述

---

## 七、已知限制和后续优化

### 当前限制

1. **背包容量固定**：`MailboxManager` 中 `backpackCapacity = 50` 是硬编码
   - **优化方案**：从 `InventoryManager` 动态获取
2. **物品定义临时**：`itemId` 字段使用字符串 ID（如 `water_001`）
   - **优化方案**：对接真实物品定义系统
3. **邮件过期未自动清理**：需要后台定时任务
   - **优化方案**：创建 Supabase Edge Function 定时清理过期邮件

### 后续扩展

- [ ] **VIP 会员系统**（Auto-Renewable Subscription）
- [ ] **赛季通行证**（Non-Renewing Subscription）
- [ ] **限时活动礼包**
- [ ] **玩家赠送功能**（邮件系统已支持）
- [ ] **订单查询页面**（已有数据表支持）

---

## 八、常见问题

### Q1: 购买后邮件没收到？

**排查步骤**：
1. 检查 Supabase 日志（Dashboard → Logs → Postgres）
2. 查看 `purchases` 表中 `is_delivered` 是否为 `true`
3. 查看 `mailbox` 表中是否有对应记录
4. 检查 `send_mail` RPC 函数是否执行成功

### Q2: 部分领取后物品丢失？

**排查步骤**：
1. 查看邮件详情中的 `items` 字段（应显示剩余物品）
2. 检查背包中是否已添加领取的物品
3. 查看 `claim_mail_partial` RPC 返回结果

### Q3: 红点提示不更新？

**解决方案**：
```swift
// 在需要刷新的地方调用
Task {
    await MailboxManager.shared.loadUnreadCount()
}
```

### Q4: 沙盒测试无法购买？

**常见原因**：
- 未配置沙盒测试账号
- Xcode 未选择正确的 StoreKit Configuration
- App 未正确签名
- 网络问题

---

## 九、联系与支持

- **开发者**: 周晓红
- **项目**: EarthLord (末日之主)
- **Bundle ID**: com.zhouxiaohong.EarthLord
- **实现日期**: 2026-02-04

---

**🎉 内购系统实现完成！现在可以在 Xcode 中运行并测试购买流程。**
