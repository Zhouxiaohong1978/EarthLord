# EarthLord 真机测试配置指南

> **目标**：在 iPhone 上测试内购系统

---

## 方式一：本地 StoreKit 测试（推荐 ⭐️）

**优点**：
- ✅ 无需沙盒账号
- ✅ 无需网络连接
- ✅ 快速测试购买流程
- ✅ 可以测试所有功能（除了真实支付）

**缺点**：
- ❌ 不会真的扣费（模拟支付）

### 步骤 1：在 Xcode 中配置签名

1. **打开项目**
   ```
   双击 EarthLord.xcodeproj 打开 Xcode
   ```

2. **选择项目目标**
   - 左侧导航栏点击 **EarthLord** 项目（蓝色图标）
   - 中间区域选择 **TARGETS** → **EarthLord**

3. **配置签名（Signing & Capabilities）**
   - 点击 **Signing & Capabilities** 标签
   - 勾选 **Automatically manage signing**
   - **Team**: 选择你的 Apple ID（如果没有，点击 "Add Account" 添加）
   - **Bundle Identifier**: 保持 `com.zhouxiaohong.EarthLord`

   ![签名配置示例](https://developer.apple.com/documentation/xcode/configuring-your-xcode-project-for-signing-1.png)

4. **验证签名状态**
   - 确保显示绿色 ✅ 图标
   - 如果显示错误，点击 "Try Again" 或修改 Bundle ID

### 步骤 2：配置 StoreKit Testing

1. **启用 StoreKit Testing**
   - 菜单栏：**Product** → **Scheme** → **Edit Scheme...**
   - 左侧选择 **Run** → **Options** 标签
   - 找到 **StoreKit Configuration**
   - 选择 `EarthLord.storekit`

   ![StoreKit Configuration](https://developer.apple.com/documentation/xcode/setting-up-storekit-testing-in-xcode-1.png)

2. **点击 Close 保存**

### 步骤 3：连接 iPhone 并运行

1. **连接 iPhone 到电脑**
   - 使用数据线连接
   - 信任此电脑（iPhone 上会弹出提示）

2. **选择设备**
   - Xcode 顶部工具栏，点击设备选择器
   - 选择你的 iPhone（如：周晓红的 iPhone）

3. **首次运行需要信任开发者**
   - 运行后 iPhone 会提示"未受信任的开发者"
   - 设置 → 通用 → VPN与设备管理 → 开发者App
   - 点击你的 Apple ID → 信任

4. **运行 App**
   ```
   Product → Run (或按 Cmd+R)
   ```

### 步骤 4：测试购买流程

1. **进入商城**
   - 打开 App → 个人 Tab → 点击右上角"购物袋"图标

2. **选择物资包**
   - 点击任意物资包卡片
   - 查看商品详情

3. **确认购买**
   - 点击"购买"按钮
   - 在确认弹窗中点击"确认购买"

4. **模拟支付**
   - **会弹出 Apple 的支付确认弹窗**
   - 显示"沙盒环境"标记
   - **点击"购买"（不会真的扣费！）**

5. **验证发货**
   - 返回个人 Tab
   - 查看邮箱图标是否显示红点
   - 进入邮箱查看邮件
   - 点击邮件 → 领取物品

### 步骤 5：测试部分领取（可选）

**修改背包容量进行测试：**

1. 打开 `EarthLord/Managers/MailboxManager.swift`
2. 找到第 46 行：
   ```swift
   private let backpackCapacity = 50
   ```
3. 临时改为：
   ```swift
   private let backpackCapacity = 5  // 测试用
   ```
4. 重新运行 App
5. 购买物资包后尝试领取
6. 验证提示："已领取 X 件物品，背包空间不足，剩余 Y 件物品请整理背包后再次领取"

---

## 方式二：沙盒环境测试（完整测试）

**适用场景**：需要测试真实的 Apple 支付流程

### 前置条件

- ✅ 已注册 Apple Developer Program（¥688/年）
- ✅ 有 App Store Connect 访问权限

### 步骤 1：创建沙盒测试账号

1. **登录 App Store Connect**
   - 访问：https://appstoreconnect.apple.com
   - 使用你的 Apple ID 登录

2. **创建沙盒测试员**
   - 点击 **用户与访问**
   - 左侧菜单选择 **沙盒技术** → **测试员**
   - 点击 **+** 添加测试员

3. **填写测试账号信息**
   - 名字：Test
   - 姓氏：User
   - 电子邮件：`test.earthlord@icloud.com`（必须是未注册过的邮箱）
   - 密码：设置一个强密码（建议记在备忘录）
   - 国家或地区：中国
   - 点击 **创建**

### 步骤 2：禁用本地 StoreKit Testing

1. **编辑 Scheme**
   - **Product** → **Scheme** → **Edit Scheme...**
   - **Run** → **Options**
   - **StoreKit Configuration**: 选择 **None**
   - 点击 Close

### 步骤 3：在 iPhone 上登录沙盒账号

⚠️ **重要**：沙盒账号**不要**在"设置 → Apple ID"中登录！

1. **确保未登录沙盒账号**
   - 设置 → App Store → 退出登录（如果有）

2. **运行 App 并购买**
   - 打开 App → 商城 → 选择物资包
   - 点击购买后会弹出登录提示
   - **在弹窗中输入沙盒测试账号**
   - 完成购买

### 步骤 4：验证购买

- 查看邮箱是否收到邮件
- 尝试领取物品
- 检查数据库（Supabase Dashboard）

---

## 常见问题

### Q1: "无法验证 App" / "未受信任的开发者"

**解决方法**：
```
iPhone 设置 → 通用 → VPN与设备管理 → 开发者App
→ 点击你的 Apple ID → 信任
```

### Q2: Xcode 提示 "Signing requires a development team"

**解决方法**：
1. Xcode → Preferences → Accounts
2. 点击 **+** → Add Apple ID
3. 输入你的 Apple ID 登录
4. 返回项目设置，Team 选择刚添加的账号

### Q3: "Could not find a team with ID" 或签名失败

**解决方法**：
1. 修改 Bundle Identifier（在末尾加上你的名字缩写）
   - 例如：`com.zhouxiaohong.EarthLord.zxh`
2. 重新选择 Team
3. 点击 "Try Again"

### Q4: 购买时提示 "Cannot connect to iTunes Store"

**原因**：使用的是本地 StoreKit Testing，这是正常的

**解决方法**：
- 确保 Scheme 中 StoreKit Configuration 设置为 `EarthLord.storekit`
- 如果还是不行，重启 Xcode 和 iPhone

### Q5: 购买后邮箱没有收到邮件

**排查步骤**：
1. 检查网络连接（需要访问 Supabase）
2. 查看 Xcode 控制台日志（搜索 "购买" 或 "发货"）
3. 登录 Supabase Dashboard 查看 `purchases` 和 `mailbox` 表
4. 检查是否有错误日志

### Q6: 沙盒测试账号提示"此 Apple ID 尚未在 iTunes Store 使用过"

**解决方法**：
- 点击"检查"
- 同意条款和条件
- 完成设置

---

## 测试检查清单

在手机上依次测试以下功能：

- [ ] App 正常启动
- [ ] 能进入商城页面
- [ ] 显示 4 个物资包（价格正确）
- [ ] 点击物资包显示详情
- [ ] 点击购买弹出确认弹窗
- [ ] 确认购买后弹出 Apple 支付弹窗
- [ ] 完成购买（本地测试不扣费）
- [ ] 显示"购买成功"提示
- [ ] 邮箱图标显示红点
- [ ] 进入邮箱看到邮件
- [ ] 点击邮件查看详情
- [ ] 点击"领取物品"成功领取
- [ ] 邮件标记为已领取
- [ ] 红点消失

---

## 推荐测试流程

### 第一次测试（快速验证）

1. ✅ 使用 **方式一：本地 StoreKit 测试**
2. ✅ 测试购买流程是否正常
3. ✅ 验证邮箱发货功能
4. ✅ 测试领取物品功能

### 第二次测试（完整验证）

1. ✅ 配置沙盒账号
2. ✅ 使用 **方式二：沙盒环境测试**
3. ✅ 测试真实支付流程
4. ✅ 验证数据库记录
5. ✅ 测试部分领取机制

---

## 注意事项

⚠️ **重要提醒**：

1. **本地 StoreKit Testing 不会真的扣费**，可以放心测试
2. **沙盒账号也不会真的扣费**，但会显示支付流程
3. **不要在 App Store 下载时使用沙盒账号**
4. **真机调试需要付费的 Apple Developer Program（¥688/年）**才能长期使用
5. **免费的 Apple ID 只能使用 7 天**，之后需要重新签名

---

## 开始测试！

现在你可以：

1. 打开 Xcode
2. 连接 iPhone
3. 配置签名（选择你的 Apple ID）
4. 运行 App (Cmd+R)
5. 测试购买流程

**祝测试顺利！** 🎉

如有问题随时告诉我。
